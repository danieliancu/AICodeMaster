import fs from "node:fs";
import path from "node:path";
import mysql from "mysql2/promise";
import type { AiLanguage } from "../src/lib/languages";

function loadEnvLocal() {
  const envPath = path.resolve(process.cwd(), ".env.local");
  if (!fs.existsSync(envPath)) return;
  const content = fs.readFileSync(envPath, "utf8");
  for (const line of content.split(/\r?\n/)) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith("#")) continue;
    const eq = trimmed.indexOf("=");
    if (eq <= 0) continue;
    const key = trimmed.slice(0, eq).trim();
    const value = trimmed.slice(eq + 1).trim().replace(/^['"]|['"]$/g, "");
    if (!(key in process.env)) process.env[key] = value;
  }
}

const UI_DB_TEXTS: Record<AiLanguage, Record<string, string>> = {
  ro: {
    newLesson: "Lectie noua",
    assistant: "AI Teacher Assistant",
    adminPanel: "Admin Panel",
    liveResult: "Rezultatul tau live",
    target: "Model",
    aiTeacher: "Profesor AI",
    online: "online",
    today: "Astazi",
    welcome: "Incepe in panoul 1 (editor), verifica in 2, apoi aliniaza cu 3. Sunt aici sa te ajut; poti intreba oricand.",
    messagePlaceholder: "Scrie un mesaj",
    seeMore: "Vezi mai mult",
    seeLess: "Vezi mai putin",
    preparingLesson: "Pregatim lectia...",
    savedLessons: "Lectii Salvate",
    aiLanguage: "Limba AI",
    cancel: "Anuleaza",
    launchLesson: "Lanseaza lectia",
    close: "Inchide",
    askTeacher: "Intreaba profesorul",
    realtime: "Asistenta in timp real",
    userAccount: "Cont utilizator",
    adminGuestNoticeTitle: "Modificarile lectiei nu se salveaza fara autentificare.",
    adminGuestNoticeDescription: "Autentifica-te pentru a pastra permanent modificarile facute in lectii pe acest cont.",
    authLogin: "Login",
    authRegister: "Register",
    authFullName: "Nume complet",
    authEmail: "Email",
    authPassword: "Parola",
    authConfirmPassword: "Confirma parola",
    authPasswordsNoMatch: "Parolele nu coincid.",
    authInvalidCredentials: "Date de autentificare invalide.",
    authMissingFields: "Completeaza toate campurile obligatorii.",
    authEmailExists: "Exista deja un cont cu acest email.",
    authUnauthorized: "Sesiunea a expirat. Te rugam sa te autentifici din nou.",
    authUnexpectedError: "A aparut o eroare neasteptata.",
    authPendingMessage: "Fluxul de autentificare va fi conectat la MySQL (localhost) in etapa urmatoare.",
    authCreateAccount: "Creeaza cont",
    authSaveProfile: "Salveaza profilul",
    authLogout: "Logout",
    authDeleteAccount: "Stergere cont",
    authDeleteConfirm: "Esti sigur ca vrei sa stergi contul?",
    authProfileSaved: "Profilul a fost actualizat.",
    techHtml: "HTML",
    techCss: "CSS",
    techJavascript: "JavaScript",
    techPython: "Python",
    techPhp: "PHP",
    techSql: "SQL",
    workspaceFlowTitle: "Workflow",
    workspaceFlowDescription: "1 Scrii in editor -> 2 Verifici live -> 3 Compari cu Model",
    panelEditorsTitle: "Editor",
    panelLiveTitle: "Rezultatul tau live",
    panelTargetTitle: "Model",
    panelEditorsHint: "Scrie codul in panoul 1.",
    panelLiveHint: "Verifica imediat ce produce codul tau in panoul 2.",
    panelTargetHint: "Compara rezultatul tau cu modelul in panoul 3.",
    startGuideCta: "Cum functioneaza",
    dismissGuideCta: "Am inteles",
    adminUserSection: "Cont utilizator",
    adminUserEmail: "User (email)",
    adminUserName: "Nume",
    adminUserPassword: "Parola noua",
    adminUserNoAccount: "Nu exista inca un cont inregistrat.",
    statusNotStarted: "Neinceput",
    statusInProgress: "In progress",
    statusCompleted: "Finalizat",
    starter_json: JSON.stringify({
      html: "<!-- Scrie HTML aici -->\n<div class=\"box\">Salut!</div>",
      css: "/* Scrie CSS aici */\n.box {\n  color: white;\n  padding: 20px;\n  background: #3b82f6;\n  border-radius: 8px;\n}",
      js: "// Scrie JS aici\nconsole.log(\"Hello World\");",
    }),
    guide_json: JSON.stringify({
      howItWorks: "Cum functioneaza",
      previous: "Anterior",
      next: "Urmatorul",
      finish: "Finalizare",
      steps: [
        { id: "editors", title: "HTML/CSS/JS", description: "Editezi codul in zone separate pentru structura, stil si comportament." },
        { id: "live", title: "Rezultatul tau live", description: "Vezi imediat efectul modificarilor in preview." },
        { id: "target", title: "Model", description: "Compari rezultatul tau cu modelul curent." },
        { id: "teacher", title: "Profesor AI", description: "Ceri explicatii si feedback contextuale pentru codul tau." },
        { id: "modes", title: "Intreaba profesorul / Asistenta in timp real", description: "Alegi intre verificare la cerere si ghidaj continuu." },
      ],
    }),
  },
  en: {
    newLesson: "New Lesson",
    assistant: "AI Teacher Assistant",
    adminPanel: "Admin Panel",
    liveResult: "Your Live Result",
    target: "Model",
    aiTeacher: "AI Teacher",
    online: "online",
    today: "Today",
    welcome: "Start in panel 1 (editor), check panel 2, then match panel 3. I'm here to help if you get stuck.",
    messagePlaceholder: "Type a message",
    seeMore: "See more",
    seeLess: "See less",
    preparingLesson: "Preparing lesson...",
    savedLessons: "Saved Lessons",
    aiLanguage: "AI Language",
    cancel: "Cancel",
    launchLesson: "Launch lesson",
    close: "Close",
    askTeacher: "Ask the teacher",
    realtime: "Real-time assistance",
    userAccount: "User account",
    adminGuestNoticeTitle: "Lesson changes are not saved without authentication.",
    adminGuestNoticeDescription: "Sign in to keep your lesson changes permanently on this account.",
    authLogin: "Login",
    authRegister: "Register",
    authFullName: "Full name",
    authEmail: "Email",
    authPassword: "Password",
    authConfirmPassword: "Confirm password",
    authPasswordsNoMatch: "Passwords do not match.",
    authInvalidCredentials: "Invalid credentials.",
    authMissingFields: "Please fill in all required fields.",
    authEmailExists: "An account with this email already exists.",
    authUnauthorized: "Session expired. Please log in again.",
    authUnexpectedError: "An unexpected error occurred.",
    authPendingMessage: "Authentication flow will be connected to MySQL (localhost) in the next step.",
    authCreateAccount: "Create account",
    authSaveProfile: "Save profile",
    authLogout: "Logout",
    authDeleteAccount: "Delete account",
    authDeleteConfirm: "Are you sure you want to delete your account?",
    authProfileSaved: "Profile updated successfully.",
    techHtml: "HTML",
    techCss: "CSS",
    techJavascript: "JavaScript",
    techPython: "Python",
    techPhp: "PHP",
    techSql: "SQL",
    workspaceFlowTitle: "Workflow",
    workspaceFlowDescription: "1 Write in editor -> 2 Check live result -> 3 Compare with model",
    panelEditorsTitle: "Editor",
    panelLiveTitle: "Your Live Result",
    panelTargetTitle: "Model",
    panelEditorsHint: "Write your code in panel 1.",
    panelLiveHint: "Check what your code renders in panel 2.",
    panelTargetHint: "Compare your output with the model in panel 3.",
    startGuideCta: "How it works",
    dismissGuideCta: "Got it",
    adminUserSection: "User account",
    adminUserEmail: "User (email)",
    adminUserName: "Name",
    adminUserPassword: "New password",
    adminUserNoAccount: "No registered account yet.",
    statusNotStarted: "Not started",
    statusInProgress: "In progress",
    statusCompleted: "Completed",
    starter_json: JSON.stringify({
      html: "<!-- Write HTML here -->\n<div class=\"box\">Hello!</div>",
      css: "/* Write CSS here */\n.box {\n  color: white;\n  padding: 20px;\n  background: #3b82f6;\n  border-radius: 8px;\n}",
      js: "// Write JS here\nconsole.log(\"Hello World\");",
    }),
    guide_json: JSON.stringify({
      howItWorks: "How it works",
      previous: "Previous",
      next: "Next",
      finish: "Finish",
      steps: [
        { id: "editors", title: "HTML/CSS/JS", description: "Edit structure, style and behavior in dedicated code panels." },
        { id: "live", title: "Your Live Result", description: "See the result update immediately while you code." },
        { id: "target", title: "Model", description: "Compare your output to the current model." },
        { id: "teacher", title: "AI Teacher", description: "Get contextual explanations and feedback." },
        { id: "modes", title: "Ask the teacher / Real-time assistance", description: "Use on-demand checks or continuous guidance." },
      ],
    }),
  },
  es: {
    newLesson: "Nueva Leccion",
    assistant: "Asistente de Profesor IA",
    adminPanel: "Panel de Admin",
    liveResult: "Tu Resultado en Vivo",
    target: "Modelo",
    aiTeacher: "Profesor IA",
    online: "en linea",
    today: "Hoy",
    welcome: "Empieza en el panel 1 (editor), revisa el 2 y luego alinea con el 3. Estoy aqui para ayudarte.",
    messagePlaceholder: "Escribe un mensaje",
    seeMore: "Ver mas",
    seeLess: "Ver menos",
    preparingLesson: "Preparando leccion...",
    savedLessons: "Lecciones Guardadas",
    aiLanguage: "Idioma IA",
    cancel: "Cancelar",
    launchLesson: "Iniciar leccion",
    close: "Cerrar",
    askTeacher: "Preguntar al profesor",
    realtime: "Asistencia en tiempo real",
    userAccount: "Cuenta de usuario",
    adminGuestNoticeTitle: "Los cambios de la leccion no se guardan sin autenticacion.",
    adminGuestNoticeDescription: "Inicia sesion para conservar de forma permanente los cambios de tus lecciones en esta cuenta.",
    authLogin: "Login",
    authRegister: "Registro",
    authFullName: "Nombre completo",
    authEmail: "Email",
    authPassword: "Contrasena",
    authConfirmPassword: "Confirmar contrasena",
    authPasswordsNoMatch: "Las contrasenas no coinciden.",
    authInvalidCredentials: "Credenciales invalidas.",
    authMissingFields: "Completa todos los campos obligatorios.",
    authEmailExists: "Ya existe una cuenta con este email.",
    authUnauthorized: "La sesion expiro. Inicia sesion de nuevo.",
    authUnexpectedError: "Ocurrio un error inesperado.",
    authPendingMessage: "El flujo de autenticacion se conectara a MySQL (localhost) en el siguiente paso.",
    authCreateAccount: "Crear cuenta",
    authSaveProfile: "Guardar perfil",
    authLogout: "Logout",
    authDeleteAccount: "Eliminar cuenta",
    authDeleteConfirm: "Seguro que quieres eliminar tu cuenta?",
    authProfileSaved: "Perfil actualizado correctamente.",
    techHtml: "HTML",
    techCss: "CSS",
    techJavascript: "JavaScript",
    techPython: "Python",
    techPhp: "PHP",
    techSql: "SQL",
    workspaceFlowTitle: "Flujo",
    workspaceFlowDescription: "1 Escribe en el editor -> 2 Revisa resultado en vivo -> 3 Compara con modelo",
    panelEditorsTitle: "Editor",
    panelLiveTitle: "Tu Resultado en Vivo",
    panelTargetTitle: "Modelo",
    panelEditorsHint: "Escribe tu codigo en el panel 1.",
    panelLiveHint: "Revisa lo que produce tu codigo en el panel 2.",
    panelTargetHint: "Compara tu resultado con el modelo en el panel 3.",
    startGuideCta: "Como funciona",
    dismissGuideCta: "Entendido",
    adminUserSection: "Cuenta de usuario",
    adminUserEmail: "Usuario (email)",
    adminUserName: "Nombre",
    adminUserPassword: "Nueva contrasena",
    adminUserNoAccount: "Aun no hay cuenta registrada.",
    statusNotStarted: "No iniciado",
    statusInProgress: "En progreso",
    statusCompleted: "Finalizado",
    starter_json: JSON.stringify({
      html: "<!-- Escribe HTML aqui -->\n<div class=\"box\">Hola!</div>",
      css: "/* Escribe CSS aqui */\n.box {\n  color: white;\n  padding: 20px;\n  background: #3b82f6;\n  border-radius: 8px;\n}",
      js: "// Escribe JS aqui\nconsole.log(\"Hello World\");",
    }),
    guide_json: JSON.stringify({
      howItWorks: "Como funciona",
      previous: "Anterior",
      next: "Siguiente",
      finish: "Finalizar",
      steps: [
        { id: "editors", title: "HTML/CSS/JS", description: "Edita estructura, estilo y comportamiento en paneles separados." },
        { id: "live", title: "Tu Resultado en Vivo", description: "Ve el resultado en tiempo real mientras escribes codigo." },
        { id: "target", title: "Modelo", description: "Compara tu resultado con el modelo actual." },
        { id: "teacher", title: "Profesor IA", description: "Recibe explicaciones y feedback contextual." },
        { id: "modes", title: "Preguntar al profesor / Asistencia en tiempo real", description: "Elige entre revision puntual y guia continua." },
      ],
    }),
  },
  fr: {
    newLesson: "Nouvelle Lecon",
    assistant: "Assistant Professeur IA",
    adminPanel: "Panneau Admin",
    liveResult: "Votre Resultat en Direct",
    target: "Modele",
    aiTeacher: "Professeur IA",
    online: "en ligne",
    today: "Aujourd'hui",
    welcome: "Commence dans le panneau 1 (editeur), verifie le 2, puis aligne avec le 3. Je suis la pour aider.",
    messagePlaceholder: "Ecrire un message",
    seeMore: "Voir plus",
    seeLess: "Voir moins",
    preparingLesson: "Preparation de la lecon...",
    savedLessons: "Lecons Enregistrees",
    aiLanguage: "Langue IA",
    cancel: "Annuler",
    launchLesson: "Lancer la lecon",
    close: "Fermer",
    askTeacher: "Demander au professeur",
    realtime: "Assistance en temps reel",
    userAccount: "Compte utilisateur",
    adminGuestNoticeTitle: "Les modifications de la lecon ne sont pas enregistrees sans authentification.",
    adminGuestNoticeDescription: "Connectez-vous pour conserver durablement les modifications de vos lecons sur ce compte.",
    authLogin: "Login",
    authRegister: "Inscription",
    authFullName: "Nom complet",
    authEmail: "Email",
    authPassword: "Mot de passe",
    authConfirmPassword: "Confirmer le mot de passe",
    authPasswordsNoMatch: "Les mots de passe ne correspondent pas.",
    authInvalidCredentials: "Identifiants invalides.",
    authMissingFields: "Veuillez remplir tous les champs obligatoires.",
    authEmailExists: "Un compte avec cet email existe deja.",
    authUnauthorized: "Session expiree. Veuillez vous reconnecter.",
    authUnexpectedError: "Une erreur inattendue est survenue.",
    authPendingMessage: "Le flux d'authentification sera connecte a MySQL (localhost) a l'etape suivante.",
    authCreateAccount: "Creer un compte",
    authSaveProfile: "Enregistrer le profil",
    authLogout: "Logout",
    authDeleteAccount: "Supprimer le compte",
    authDeleteConfirm: "Voulez-vous vraiment supprimer votre compte ?",
    authProfileSaved: "Profil mis a jour avec succes.",
    techHtml: "HTML",
    techCss: "CSS",
    techJavascript: "JavaScript",
    techPython: "Python",
    techPhp: "PHP",
    techSql: "SQL",
    workspaceFlowTitle: "Flux",
    workspaceFlowDescription: "1 Ecris dans l'editeur -> 2 Verifie le resultat live -> 3 Compare avec le modele",
    panelEditorsTitle: "Editeur",
    panelLiveTitle: "Votre Resultat en Direct",
    panelTargetTitle: "Modele",
    panelEditorsHint: "Ecris ton code dans le panneau 1.",
    panelLiveHint: "Verifie ce que produit ton code dans le panneau 2.",
    panelTargetHint: "Compare ton resultat avec le modele dans le panneau 3.",
    startGuideCta: "Comment ca marche",
    dismissGuideCta: "Compris",
    adminUserSection: "Compte utilisateur",
    adminUserEmail: "Utilisateur (email)",
    adminUserName: "Nom",
    adminUserPassword: "Nouveau mot de passe",
    adminUserNoAccount: "Aucun compte enregistre pour le moment.",
    statusNotStarted: "Non commence",
    statusInProgress: "En cours",
    statusCompleted: "Termine",
    starter_json: JSON.stringify({
      html: "<!-- Ecris le HTML ici -->\n<div class=\"box\">Salut!</div>",
      css: "/* Ecris le CSS ici */\n.box {\n  color: white;\n  padding: 20px;\n  background: #3b82f6;\n  border-radius: 8px;\n}",
      js: "// Ecris le JS ici\nconsole.log(\"Hello World\");",
    }),
    guide_json: JSON.stringify({
      howItWorks: "Comment ca marche",
      previous: "Precedent",
      next: "Suivant",
      finish: "Terminer",
      steps: [
        { id: "editors", title: "HTML/CSS/JS", description: "Editez structure, style et comportement dans des panneaux dedies." },
        { id: "live", title: "Votre Resultat en Direct", description: "Le resultat se met a jour en temps reel." },
        { id: "target", title: "Modele", description: "Comparez votre resultat avec le modele actuel." },
        { id: "teacher", title: "Professeur IA", description: "Obtenez des explications et un feedback contextuel." },
        { id: "modes", title: "Demander au professeur / Assistance en temps reel", description: "Choisissez verification a la demande ou guidage continu." },
      ],
    }),
  },
  de: {
    newLesson: "Neue Lektion",
    assistant: "KI Lehrer Assistent",
    adminPanel: "Admin-Bereich",
    liveResult: "Dein Live-Ergebnis",
    target: "Modell",
    aiTeacher: "KI Lehrer",
    online: "online",
    today: "Heute",
    welcome: "Starte in Bereich 1 (Editor), pruefe Bereich 2 und gleiche dann mit Bereich 3 ab. Ich helfe dir dabei.",
    messagePlaceholder: "Nachricht schreiben",
    seeMore: "Mehr anzeigen",
    seeLess: "Weniger anzeigen",
    preparingLesson: "Lektion wird vorbereitet...",
    savedLessons: "Gespeicherte Lektionen",
    aiLanguage: "KI-Sprache",
    cancel: "Abbrechen",
    launchLesson: "Lektion starten",
    close: "Schliessen",
    askTeacher: "Lehrer fragen",
    realtime: "Echtzeit-Hilfe",
    userAccount: "Benutzerkonto",
    adminGuestNoticeTitle: "Aenderungen an der Lektion werden ohne Anmeldung nicht gespeichert.",
    adminGuestNoticeDescription: "Melde dich an, um deine Lektionen-Aenderungen dauerhaft in diesem Konto zu speichern.",
    authLogin: "Login",
    authRegister: "Registrieren",
    authFullName: "Vollstandiger Name",
    authEmail: "E-Mail",
    authPassword: "Passwort",
    authConfirmPassword: "Passwort bestatigen",
    authPasswordsNoMatch: "Passworter stimmen nicht uberein.",
    authInvalidCredentials: "Ungultige Zugangsdaten.",
    authMissingFields: "Bitte alle Pflichtfelder ausfullen.",
    authEmailExists: "Ein Konto mit dieser E-Mail existiert bereits.",
    authUnauthorized: "Sitzung abgelaufen. Bitte erneut anmelden.",
    authUnexpectedError: "Ein unerwarteter Fehler ist aufgetreten.",
    authPendingMessage: "Der Authentifizierungsfluss wird im nachsten Schritt mit MySQL (localhost) verbunden.",
    authCreateAccount: "Konto erstellen",
    authSaveProfile: "Profil speichern",
    authLogout: "Logout",
    authDeleteAccount: "Konto loschen",
    authDeleteConfirm: "Mochtest du dein Konto wirklich loschen?",
    authProfileSaved: "Profil erfolgreich aktualisiert.",
    techHtml: "HTML",
    techCss: "CSS",
    techJavascript: "JavaScript",
    techPython: "Python",
    techPhp: "PHP",
    techSql: "SQL",
    workspaceFlowTitle: "Ablauf",
    workspaceFlowDescription: "1 Im Editor schreiben -> 2 Live-Ergebnis pruefen -> 3 Mit Modell vergleichen",
    panelEditorsTitle: "Editor",
    panelLiveTitle: "Dein Live-Ergebnis",
    panelTargetTitle: "Modell",
    panelEditorsHint: "Schreibe deinen Code in Bereich 1.",
    panelLiveHint: "Pruefe in Bereich 2, was dein Code erzeugt.",
    panelTargetHint: "Vergleiche dein Ergebnis mit dem Modell in Bereich 3.",
    startGuideCta: "So funktioniert es",
    dismissGuideCta: "Verstanden",
    adminUserSection: "Benutzerkonto",
    adminUserEmail: "Benutzer (E-Mail)",
    adminUserName: "Name",
    adminUserPassword: "Neues Passwort",
    adminUserNoAccount: "Noch kein registriertes Konto.",
    statusNotStarted: "Nicht begonnen",
    statusInProgress: "In Arbeit",
    statusCompleted: "Abgeschlossen",
    starter_json: JSON.stringify({
      html: "<!-- Schreibe HTML hier -->\n<div class=\"box\">Hallo!</div>",
      css: "/* Schreibe CSS hier */\n.box {\n  color: white;\n  padding: 20px;\n  background: #3b82f6;\n  border-radius: 8px;\n}",
      js: "// Schreibe JS hier\nconsole.log(\"Hello World\");",
    }),
    guide_json: JSON.stringify({
      howItWorks: "So funktioniert es",
      previous: "Zuruck",
      next: "Weiter",
      finish: "Fertig",
      steps: [
        { id: "editors", title: "HTML/CSS/JS", description: "Bearbeite Struktur, Stil und Verhalten in eigenen Bereichen." },
        { id: "live", title: "Dein Live-Ergebnis", description: "Sieh sofort, was dein Code erzeugt." },
        { id: "target", title: "Modell", description: "Vergleiche dein Ergebnis mit dem aktuellen Modell." },
        { id: "teacher", title: "KI Lehrer", description: "Erhalte kontextbezogene Erklarungen und Feedback." },
        { id: "modes", title: "Lehrer fragen / Echtzeit-Hilfe", description: "Nutze Prufung auf Anfrage oder kontinuierliche Hilfe." },
      ],
    }),
  },
  it: {
    newLesson: "Nuova Lezione",
    assistant: "Assistente Insegnante IA",
    adminPanel: "Pannello Admin",
    liveResult: "Il Tuo Risultato Live",
    target: "Modello",
    aiTeacher: "Professore IA",
    online: "online",
    today: "Oggi",
    welcome: "Inizia nel pannello 1 (editor), controlla il 2 e poi allinea con il 3. Sono qui per aiutarti.",
    messagePlaceholder: "Scrivi un messaggio",
    seeMore: "Vedi di piu",
    seeLess: "Vedi meno",
    preparingLesson: "Preparazione della lezione...",
    savedLessons: "Lezioni Salvate",
    aiLanguage: "Lingua IA",
    cancel: "Annulla",
    launchLesson: "Avvia lezione",
    close: "Chiudi",
    askTeacher: "Chiedi al professore",
    realtime: "Assistenza in tempo reale",
    userAccount: "Account utente",
    adminGuestNoticeTitle: "Le modifiche della lezione non vengono salvate senza autenticazione.",
    adminGuestNoticeDescription: "Accedi per mantenere in modo permanente le modifiche delle lezioni su questo account.",
    authLogin: "Login",
    authRegister: "Registrati",
    authFullName: "Nome completo",
    authEmail: "Email",
    authPassword: "Password",
    authConfirmPassword: "Conferma password",
    authPasswordsNoMatch: "Le password non coincidono.",
    authInvalidCredentials: "Credenziali non valide.",
    authMissingFields: "Compila tutti i campi obbligatori.",
    authEmailExists: "Esiste gia un account con questa email.",
    authUnauthorized: "Sessione scaduta. Accedi di nuovo.",
    authUnexpectedError: "Si e verificato un errore imprevisto.",
    authPendingMessage: "Il flusso di autenticazione sara collegato a MySQL (localhost) nel prossimo passaggio.",
    authCreateAccount: "Crea account",
    authSaveProfile: "Salva profilo",
    authLogout: "Logout",
    authDeleteAccount: "Elimina account",
    authDeleteConfirm: "Sei sicuro di voler eliminare il tuo account?",
    authProfileSaved: "Profilo aggiornato con successo.",
    techHtml: "HTML",
    techCss: "CSS",
    techJavascript: "JavaScript",
    techPython: "Python",
    techPhp: "PHP",
    techSql: "SQL",
    workspaceFlowTitle: "Flusso",
    workspaceFlowDescription: "1 Scrivi nell'editor -> 2 Controlla il risultato live -> 3 Confronta con modello",
    panelEditorsTitle: "Editor",
    panelLiveTitle: "Il Tuo Risultato Live",
    panelTargetTitle: "Modello",
    panelEditorsHint: "Scrivi il codice nel pannello 1.",
    panelLiveHint: "Controlla nel pannello 2 cosa produce il codice.",
    panelTargetHint: "Confronta il risultato con il modello nel pannello 3.",
    startGuideCta: "Come funziona",
    dismissGuideCta: "Capito",
    adminUserSection: "Account utente",
    adminUserEmail: "Utente (email)",
    adminUserName: "Nome",
    adminUserPassword: "Nuova password",
    adminUserNoAccount: "Nessun account registrato.",
    statusNotStarted: "Non iniziato",
    statusInProgress: "In corso",
    statusCompleted: "Completato",
    starter_json: JSON.stringify({
      html: "<!-- Scrivi HTML qui -->\n<div class=\"box\">Ciao!</div>",
      css: "/* Scrivi CSS qui */\n.box {\n  color: white;\n  padding: 20px;\n  background: #3b82f6;\n  border-radius: 8px;\n}",
      js: "// Scrivi JS qui\nconsole.log(\"Hello World\");",
    }),
    guide_json: JSON.stringify({
      howItWorks: "Come funziona",
      previous: "Precedente",
      next: "Successivo",
      finish: "Fine",
      steps: [
        { id: "editors", title: "HTML/CSS/JS", description: "Modifica struttura, stile e comportamento in pannelli separati." },
        { id: "live", title: "Il Tuo Risultato Live", description: "Vedi subito il risultato del tuo codice." },
        { id: "target", title: "Modello", description: "Confronta il tuo risultato con il modello corrente." },
        { id: "teacher", title: "Professore IA", description: "Ricevi spiegazioni e feedback contestuale." },
        { id: "modes", title: "Chiedi al professore / Assistenza in tempo reale", description: "Scegli tra verifica su richiesta o guida continua." },
      ],
    }),
  },
  pt: {
    newLesson: "Nova Licao",
    assistant: "Assistente de Professor IA",
    adminPanel: "Painel Admin",
    liveResult: "Seu Resultado Ao Vivo",
    target: "Modelo",
    aiTeacher: "Professor IA",
    online: "online",
    today: "Hoje",
    welcome: "Comece no painel 1 (editor), confira o 2 e depois alinhe com o 3. Estou aqui para te ajudar.",
    messagePlaceholder: "Escreva uma mensagem",
    seeMore: "Ver mais",
    seeLess: "Ver menos",
    preparingLesson: "Preparando licao...",
    savedLessons: "Licoes Salvas",
    aiLanguage: "Idioma IA",
    cancel: "Cancelar",
    launchLesson: "Iniciar licao",
    close: "Fechar",
    askTeacher: "Perguntar ao professor",
    realtime: "Assistencia em tempo real",
    userAccount: "Conta de usuario",
    adminGuestNoticeTitle: "As alteracoes da licao nao sao salvas sem autenticacao.",
    adminGuestNoticeDescription: "Faca login para manter permanentemente as alteracoes das licoes nesta conta.",
    authLogin: "Login",
    authRegister: "Registrar",
    authFullName: "Nome completo",
    authEmail: "Email",
    authPassword: "Senha",
    authConfirmPassword: "Confirmar senha",
    authPasswordsNoMatch: "As senhas nao coincidem.",
    authInvalidCredentials: "Credenciais invalidas.",
    authMissingFields: "Preencha todos os campos obrigatorios.",
    authEmailExists: "Ja existe uma conta com este email.",
    authUnauthorized: "Sessao expirada. Faça login novamente.",
    authUnexpectedError: "Ocorreu um erro inesperado.",
    authPendingMessage: "O fluxo de autenticacao sera conectado ao MySQL (localhost) na proxima etapa.",
    authCreateAccount: "Criar conta",
    authSaveProfile: "Salvar perfil",
    authLogout: "Logout",
    authDeleteAccount: "Excluir conta",
    authDeleteConfirm: "Tem certeza que deseja excluir sua conta?",
    authProfileSaved: "Perfil atualizado com sucesso.",
    techHtml: "HTML",
    techCss: "CSS",
    techJavascript: "JavaScript",
    techPython: "Python",
    techPhp: "PHP",
    techSql: "SQL",
    workspaceFlowTitle: "Fluxo",
    workspaceFlowDescription: "1 Escreva no editor -> 2 Confira resultado ao vivo -> 3 Compare com modelo",
    panelEditorsTitle: "Editor",
    panelLiveTitle: "Seu Resultado Ao Vivo",
    panelTargetTitle: "Modelo",
    panelEditorsHint: "Escreva seu codigo no painel 1.",
    panelLiveHint: "Confira no painel 2 o que seu codigo produz.",
    panelTargetHint: "Compare seu resultado com o modelo no painel 3.",
    startGuideCta: "Como funciona",
    dismissGuideCta: "Entendi",
    adminUserSection: "Conta de usuario",
    adminUserEmail: "Usuario (email)",
    adminUserName: "Nome",
    adminUserPassword: "Nova senha",
    adminUserNoAccount: "Ainda nao existe conta registrada.",
    statusNotStarted: "Nao iniciado",
    statusInProgress: "Em progresso",
    statusCompleted: "Finalizado",
    starter_json: JSON.stringify({
      html: "<!-- Escreva HTML aqui -->\n<div class=\"box\">Ola!</div>",
      css: "/* Escreva CSS aqui */\n.box {\n  color: white;\n  padding: 20px;\n  background: #3b82f6;\n  border-radius: 8px;\n}",
      js: "// Escreva JS aqui\nconsole.log(\"Hello World\");",
    }),
    guide_json: JSON.stringify({
      howItWorks: "Como funciona",
      previous: "Anterior",
      next: "Proximo",
      finish: "Concluir",
      steps: [
        { id: "editors", title: "HTML/CSS/JS", description: "Edite estrutura, estilo e comportamento em painéis separados." },
        { id: "live", title: "Seu Resultado Ao Vivo", description: "Veja imediatamente o resultado do seu codigo." },
        { id: "target", title: "Modelo", description: "Compare seu resultado com o modelo atual." },
        { id: "teacher", title: "Professor IA", description: "Receba explicacoes e feedback contextual." },
        { id: "modes", title: "Perguntar ao professor / Assistencia em tempo real", description: "Escolha verificacao sob demanda ou orientacao continua." },
      ],
    }),
  },
};

const LONG_GUIDES: Record<
  AiLanguage,
  {
    howItWorks: string;
    previous: string;
    next: string;
    finish: string;
    steps: { id: "editors" | "live" | "target" | "teacher" | "modes"; title: string; description: string }[];
  }
> = {
  ro: {
    howItWorks: "Cum functioneaza",
    previous: "Anterior",
    next: "Urmatorul",
    finish: "Finalizare",
    steps: [
      { id: "editors", title: "1. Editor", description: "Scrii codul in editor (HTML pentru structura, CSS pentru stil, JS pentru comportament)." },
      { id: "live", title: "2. Rezultatul tau live", description: "Verifici imediat in preview live ce produce codul tau." },
      { id: "target", title: "3. Model", description: "Compari rezultatul tau cu Modelul si ajustezi pana se potrivesc." },
      { id: "teacher", title: "Profesor AI", description: "Profesorul AI completeaza fluxul de lucru atunci cand ai nevoie de explicatii, feedback sau directie tehnica. Avantajul este asistenta contextuala, bazata pe exercitiul activ si pe codul scris. Folosit impreuna cu editorul, rezultatul live si obiectivul, chatul accelereaza rezolvarea blocajelor si te ajuta sa intelegi nu doar ce sa schimbi, ci si de ce." },
      { id: "modes", title: "Intreaba profesorul / Asistenta in timp real", description: "Cele doua moduri controleaza cum primesti feedback. Intreaba profesorul declanseaza verificare la cerere, utila cand vrei validare punctuala dupa o schimbare importanta. Asistenta in timp real monitorizeaza continuu progresul si ofera ghidaj constant. Folosite corect impreuna, reduci incercarile inutile si ajustezi mai rapid codul in functie de obiectiv." },
    ],
  },
  en: {
    howItWorks: "How it works",
    previous: "Previous",
    next: "Next",
    finish: "Finish",
    steps: [
      { id: "editors", title: "1. Editor", description: "Write your code in the editor (HTML for structure, CSS for style, JS for behavior)." },
      { id: "live", title: "2. Your Live Result", description: "Check immediately in live preview what your code produces." },
      { id: "target", title: "3. Model", description: "Compare your result with the Model and adjust until they match." },
      { id: "teacher", title: "AI Teacher", description: "The AI Teacher is the support layer for explanations, feedback, and next-step guidance when you get stuck. Its key benefit is contextual help based on the active exercise and your current code. Combined with the editor, live result, and target view, it speeds up problem solving and improves understanding of both what to change and why." },
      { id: "modes", title: "Ask the teacher / Real-time assistance", description: "These two buttons control how feedback is delivered. Ask the teacher runs an on-demand review, useful when you want a focused check after a meaningful update. Real-time assistance keeps guidance active while you work and helps catch issues earlier. Using both modes strategically creates faster iteration and a cleaner path to the target result." },
    ],
  },
  es: {
    howItWorks: "Como funciona",
    previous: "Anterior",
    next: "Siguiente",
    finish: "Finalizar",
    steps: [
      { id: "editors", title: "1. Editor", description: "Escribe tu codigo en el editor (HTML para estructura, CSS para estilo, JS para comportamiento)." },
      { id: "live", title: "2. Tu Resultado en Vivo", description: "Revisa de inmediato en preview en vivo lo que produce tu codigo." },
      { id: "target", title: "3. Modelo", description: "Compara tu resultado con el Modelo y ajusta hasta que coincidan." },
      { id: "teacher", title: "Profesor IA", description: "El Profesor IA complementa el flujo cuando necesitas explicaciones, retroalimentacion o direccion tecnica. La ventaja principal es la ayuda contextual basada en el ejercicio activo y en tu implementacion actual. Integrado con editor, resultado en vivo y objetivo, acelera la resolucion de bloqueos y mejora la comprension tecnica." },
      { id: "modes", title: "Preguntar al profesor / Asistencia en tiempo real", description: "Estos dos botones definen como recibes feedback. Preguntar al profesor ejecuta una revision bajo demanda, ideal para validar cambios importantes en momentos clave. Asistencia en tiempo real mantiene orientacion continua mientras avanzas. Combinarlos de forma inteligente acelera la iteracion y mejora la alineacion con el objetivo del ejercicio." },
    ],
  },
  fr: {
    howItWorks: "Comment ca marche",
    previous: "Precedent",
    next: "Suivant",
    finish: "Terminer",
    steps: [
      { id: "editors", title: "1. Editeur", description: "Ecris ton code dans l'editeur (HTML pour la structure, CSS pour le style, JS pour le comportement)." },
      { id: "live", title: "2. Votre Resultat en Direct", description: "Verifie immediatement dans l'aperçu en direct ce que produit ton code." },
      { id: "target", title: "3. Modele", description: "Compare ton resultat avec le Modele et ajuste jusqu'a ce que cela corresponde." },
      { id: "teacher", title: "Professeur IA", description: "Le Professeur IA apporte une assistance contextualisee quand vous avez besoin d'explications, de feedback ou d'orientation technique. Son avantage est de s'appuyer sur l'exercice actif et votre code en cours. Combine aux autres panneaux, il accelere la resolution des blocages et renforce la comprehension." },
      { id: "modes", title: "Demander au professeur / Assistance en temps reel", description: "Ces deux boutons definissent le mode de feedback. Demander au professeur lance une verification a la demande, pratique pour valider une etape importante. Assistance en temps reel maintient un accompagnement continu pendant le travail. Leur combinaison permet d'iterer plus vite et d'aligner plus efficacement votre resultat avec l'objectif." },
    ],
  },
  de: {
    howItWorks: "So funktioniert es",
    previous: "Zuruck",
    next: "Weiter",
    finish: "Fertig",
    steps: [
      { id: "editors", title: "1. Editor", description: "Schreibe deinen Code im Editor (HTML fuer Struktur, CSS fuer Stil, JS fuer Verhalten)." },
      { id: "live", title: "2. Dein Live-Ergebnis", description: "Pruefe sofort in der Live-Vorschau, was dein Code erzeugt." },
      { id: "target", title: "3. Modell", description: "Vergleiche dein Ergebnis mit dem Modell und passe es an, bis es passt." },
      { id: "teacher", title: "KI Lehrer", description: "Der KI-Lehrer unterstuetzt dich mit Erklaerungen, Feedback und konkreten naechsten Schritten, wenn du feststeckst. Der wichtigste Vorteil ist kontextbezogene Hilfe auf Basis der aktiven Aufgabe und deines aktuellen Codes. Zusammen mit den anderen Bereichen beschleunigt das die Problemloesung und verbessert dein Verstaendnis." },
      { id: "modes", title: "Lehrer fragen / Echtzeit-Hilfe", description: "Diese beiden Schaltflaechen steuern, wie Rueckmeldung erfolgt. Lehrer fragen startet eine gezielte Pruefung auf Anfrage und ist ideal fuer punktuelle Validierung. Echtzeit-Hilfe begleitet den Prozess kontinuierlich und erkennt Probleme frueher. Der kombinierte Einsatz verkuerzt Iterationen und fuehrt schneller zum Zielergebnis." },
    ],
  },
  it: {
    howItWorks: "Come funziona",
    previous: "Precedente",
    next: "Successivo",
    finish: "Fine",
    steps: [
      { id: "editors", title: "1. Editor", description: "Scrivi il codice nell'editor (HTML per la struttura, CSS per lo stile, JS per il comportamento)." },
      { id: "live", title: "2. Il Tuo Risultato Live", description: "Controlla subito in anteprima live cosa produce il tuo codice." },
      { id: "target", title: "3. Modello", description: "Confronta il tuo risultato con il Modello e correggi finche coincidono." },
      { id: "teacher", title: "Professore IA", description: "Il Professore IA completa il flusso quando servono spiegazioni, feedback o guida tecnica. Il vantaggio chiave e l'assistenza contestuale basata sull'esercizio attivo e sul codice attuale. Integrato con editor, risultato live e obiettivo, accelera lo sblocco dei problemi e migliora la comprensione." },
      { id: "modes", title: "Chiedi al professore / Assistenza in tempo reale", description: "Questi due pulsanti definiscono come ricevere feedback. Chiedi al professore avvia una revisione su richiesta, utile per controlli mirati dopo modifiche importanti. Assistenza in tempo reale mantiene supporto continuo durante lo sviluppo. Usarli insieme in modo strategico riduce i tentativi inutili e accelera il raggiungimento dell'obiettivo." },
    ],
  },
  pt: {
    howItWorks: "Como funciona",
    previous: "Anterior",
    next: "Proximo",
    finish: "Concluir",
    steps: [
      { id: "editors", title: "1. Editor", description: "Escreva seu codigo no editor (HTML para estrutura, CSS para estilo, JS para comportamento)." },
      { id: "live", title: "2. Seu Resultado Ao Vivo", description: "Confira imediatamente no preview ao vivo o que seu codigo produz." },
      { id: "target", title: "3. Modelo", description: "Compare seu resultado com o Modelo e ajuste ate ficar igual." },
      { id: "teacher", title: "Professor IA", description: "O Professor IA complementa o fluxo quando voce precisa de explicacoes, feedback ou orientacao tecnica. O principal beneficio e a ajuda contextual, baseada no exercicio ativo e no seu codigo atual. Integrado com editor, resultado ao vivo e objetivo, acelera a resolucao de bloqueios e melhora o aprendizado." },
      { id: "modes", title: "Perguntar ao professor / Assistencia em tempo real", description: "Esses dois botoes controlam como o feedback acontece. Perguntar ao professor faz uma revisao sob demanda, ideal para validar alteracoes importantes em momentos especificos. Assistencia em tempo real oferece acompanhamento continuo durante a construcao. O uso combinado acelera iteracoes e melhora o alinhamento com o objetivo." },
    ],
  },
};

async function run() {
  loadEnvLocal();
  const conn = await mysql.createConnection({
    host: process.env.DB_HOST || "127.0.0.1",
    port: Number(process.env.DB_PORT || 3306),
    user: process.env.DB_USER || "root",
    password: process.env.DB_PASSWORD || "",
    database: process.env.DB_NAME || "ai_code_master",
  });
  try {
    for (const [language, dict] of Object.entries(UI_DB_TEXTS) as [AiLanguage, Record<string, string>][]) {
      const effectiveDict: Record<string, string> = {
        ...dict,
        guide_json: JSON.stringify(LONG_GUIDES[language]),
      };
      for (const [key, value] of Object.entries(effectiveDict)) {
        await conn.query(
          `
          INSERT INTO app_translations (language_code, \`key\`, value)
          VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE value = VALUES(value), updated_at = CURRENT_TIMESTAMP
          `,
          [language, key, value],
        );
      }
    }
    console.log("UI translations migrated.");
  } finally {
    await conn.end();
  }
}

run().catch((error) => {
  console.error("UI translation migration failed:", error);
  process.exit(1);
});

